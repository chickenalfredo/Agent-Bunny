<html>
	<head>
		<title>Level Editor - Cloudy Yunfan</title>
		<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://unpkg.com/feather-icons"></script>
		<style>
			body{
				background-color: #f7f9fc;
				padding: 0px;
				margin: 0px;
			}


			td{
				background: #ededed;
				padding: 0px;
				margin: 0px;
			}

			.header{
				height: 80px;
				position: fixed;
				width: 100%;
				background: #fff;
				box-shadow: 0px 0px 20px #ededed;
				z-index: 998;
			}

			.float-select{
				position: fixed;
				background-color: #fff;
				box-shadow: 0px 0px 8px #f2f2f2;
				top: 0px;
				left: 0px;
				width: 64px;
				z-index: 999;
				border-radius: 50px;
				height: 60%;
				overflow: hidden;
			}

			.float-select-wrapper{
				overflow-x: hidden;
				overflow-y: scroll;
				width: calc(100% + 17px);
				position: relative;
				height: 100%;
				margin: 0px;
			}

			#map-margin{
				margin-top: -10%;
				padding: 20%;
				position: absolute;
			}

			#map{
				padding: 0px;
				margin: 0px;
				width: auto;
				border-collapse: collapse;
				box-shadow: 0px 0px 20px #ededed;
			}

			#map-container{
				overflow: scroll;
				position: fixed;
				height: calc(100% - 80px);
				width: 100%;
				top: 80px;
				padding: 0px;
			}

			#generate-java-code{
				top: 80px;
				height: calc(100% - 80px);
				position: fixed;
				width: 100%;
			}

			.btn{
				outline: none !important;
				border: none;
				padding: 10px 15px;
				transition: .2s all;
				background-color: transparent;
				margin: 5px;
				overflow: hidden;
				cursor: pointer;
			}

			.btn:hover{
				box-shadow: 0px 0px 8px #f2f2f2;
				background-color: #f2f2f2;
			}

			.btn[disabled]{
				color: #d3d3d3;
				background-color: transparent;
				box-shadow: none;
			}

			.btn-main{
				border-radius: 50%;
				padding: 15px;
				height: 54px;
				width: 54px;
			}

			.btn-wrapper{
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}

			.block{
				position: relative;
				width: 100%;
				height: 100%;
				width: 34px;
				height: 34px;
				outline: none !important;
				border: 0.25px dashed #e5e5e5;
				background-color: #fcfcfc;
				margin: 0px;
				padding: 0px;
			}


			.block img{
				margin: 0px;
			}

			.btn-image{
				height: 24px;
				width: 24px;
				top: 0px;
				left: 0px;
				margin: 0px;
			}

			.btn-block{
				height: 100%;
				width: 100%;
				top: 0px;
				left: 0px;
				margin: 0px;
				position: relative;
			}

			.float-select-hr{
				width: 30%;
				margin: 10px auto;
				border: 0.5px solid #cecece;
			}

			.block[none_border=true]{
				border: none !important; 
			}

			.btn-pen-tool-select[select=true]{
				background-color: #eee;
			}

			#java-code{
				width: 100%;
				height: 100%;
				font-family: 'Consolas';
				font-weight: 100;
			}

			.float-object-config{
				position: fixed;
				top: 0px;
				left: 0px;
			}

		</style>
	</head>
	<body>

		<div class="header">
			<div class="btn-wrapper">
				<!--<button class="btn btn-main" disabled><i data-feather="rotate-ccw"></i></button>-->
				<button class="btn btn-main" id="clear-map" title="Clear Map"><i data-feather="trash-2"></i></button>
				<button class="btn btn-main" id="pen-tool" title="Pen Tool"><i data-feather="pen-tool"></i></button>
				<button class="btn btn-main" id="map-setting" title="Map Size"><i data-feather="settings"></i></button>
				<button class="btn btn-main" id="generate-map" title="Java Code"><i data-feather="code"></i></button>
				<button class="btn btn-main" id="edit-map" title="Map Design"><i data-feather="map"></i></button>
			</div>
		</div>

		<div class="float-select" id="pen-tool-float-select">
			<div class="float-select-wrapper" id="pen-tool-float-select-wrapper"></div>
		</div>

		<div class="float-object-config" id="pen-tool-float-select">
			
		</div>

		<div id="map-container">
			<div id="map-margin"><table id="map"></table></div>
		</div>

		<div id="generate-java-code">
			<textarea id="java-code"></textarea>
		</div>

		<script>
			$('.float-select').hide();
			$('#generate-java-code').hide();
			$('#edit-map').toggle();

			$('#pen-tool').click(function(){
				var offset = $(this).offset();
				$('#pen-tool-float-select').offset({top: offset.top - 5, left: offset.left - 5});
				$('#pen-tool-float-select').fadeIn(100);
			});

			$('#generate-map').click(function(){
				$('#map-container').fadeOut(500);
				$('#generate-java-code').fadeIn(500);
				$('#edit-map').toggle();
				$('#generate-map').toggle();
				generateJava();
			});

			$('#edit-map').click(function(){
				$('#edit-map').toggle();
				$('#generate-map').toggle();
				$('#generate-java-code').fadeOut(500);
				$('#map-container').fadeIn(500);
				drawCodeMap();
			});

		</script>


		<script>
			var h = 20;
			var w = 30;
			var down = false; // mouse down
			var mapJson = {};
			var pen_tool = {'jPath': '', 'sprite_components': [], 'size': []};

			const ASSETS_DIRECTORY = '../resources/assets/';

			var spriteDirectoryList = {
				"Eraser":{
					"eraser": [0]
				},
				"Block": {
					"grass4": [1, 2, 3, 4],
					"floatblock": {"left": null, "middle": [1, 2], "right": null},
				},
				"CheckPoint":{
					"checkpoint": [1, 2],
				},
				"EndPoint": {
					"endpoint": [1],
				},
				"Decoration": {
					"box": [1, 2],
					"grass": [1],
				},
			}

			$('#pen-tool-float-select-wrapper').html('');

			var pen_tool_increment = 0;
			readSpriteDirectory2PenTool(Array(), spriteDirectoryList);
			function readSpriteDirectory2PenTool(spriteComponents, directoryArray){

				if(spriteComponents.length == 2){
					console.log(spriteComponents);
					pen_tool_increment ++;
			 		$('#pen-tool-float-select-wrapper').append('<div class="float-select-hr" id="pen_tool_hr_' + pen_tool_increment + '"></div>');
				}


				if(directoryArray instanceof Array || directoryArray == null){

					if(directoryArray == null){
						directoryArray = [-9999];
					}

					for(each of directoryArray){

						var newSpriteComponents = JSON.parse(JSON.stringify(spriteComponents));
						if(each != -9999){
							newSpriteComponents.push(each);
						}
						
						console.log(newSpriteComponents);
						var id = newSpriteComponents.join('_');
						var title = newSpriteComponents.join(' ');
						var jPath = id + '.png';
						var path = ASSETS_DIRECTORY + jPath;
					
						var bWidth = 1;
		 				var bHeight = 1;

						$('#pen-tool-float-select-wrapper').append('<button class="btn btn-main btn-pen-tool-select" id="' + id + '" title="' + title + '" bWidth="' + bWidth + '" bHeight="' + bHeight + '" jPath="' + jPath + '"><img class="btn-image" src="' + path + '"></button>');
					}

					return;
				}


				for(each in directoryArray){
					var newSpriteComponents = JSON.parse(JSON.stringify(spriteComponents));
					newSpriteComponents.push(each);
					readSpriteDirectory2PenTool(newSpriteComponents, directoryArray[each]);
				}

			}

			$('#pen_tool_hr_1').hide();


			$('.btn-pen-tool-select').click(function(){
				$('.btn-pen-tool-select').removeAttr('select');
				$('#pen-tool-float-select').offset({left: 0, top: 0});
				$('#pen-tool-float-select').hide();
				pen_tool['jPath'] = $(this).attr('jPath');
				pen_tool['sprite_components'] = $(this).attr('id').split('_');
				pen_tool['size'][0] = $(this).attr('bWidth') * 1;
				pen_tool['size'][1] = $(this).attr('bHeight') * 1;
				$(this).attr('select', 'true');
				console.log(pen_tool);
			});

			$('#Eraser_eraser_0').click();


			drawNewMap();

			$('#clear-map').click(function(){
				if(confirm('Are you sure to clear the whole map?')){
					drawNewMap();
				}
			});

			function drawNewMap(){
				mapJson = {};
				mapJson['size'] = {};
				mapJson['block'] = [];
				mapJson['size']['h'] = h;
				mapJson['size']['w'] = w;


				$('#map').html('');
				for(var t = 0; t < h; t ++){
					var inside = '';
					mapJson['block'][t] = Array();
					for(var i = 0; i < w; i ++){
						inside += '<td><button class="block" id="h' + t + 'w' + i + '" x="' + t + '" y="' + i + '"></button></td>';
						mapJson['block'][t][i] = null;
					}
					$('#map').append('<tr id="h' + t + '">' + inside + '</tr>');
				}

				drawMap();
			}

			function drawCodeMap(){
				var text = $('#java-code').val();

				var json = substr(text, '<!----level_editor----', '---->');
				mapJson = JSON.parse(json);

				console.log(mapJson);

				w = mapJson['size']['w'];
				h = mapJson['size']['h'];

				$('#map').html('');
				for(var t = 0; t < h; t ++){
					var inside = '';
					for(var i = 0; i < w; i ++){
						if(mapJson['block'][t][i] == null){
							inside += '<td><button class="block" id="h' + t + 'w' + i + '" x="' + t + '" y="' + i + '"></button></td>';
						}else{
							inside += '<td><button class="block" id="h' + t + 'w' + i + '" x="' + t + '" y="' + i + '" none_border="true"><img class="btn-block" src="' + ASSETS_DIRECTORY + mapJson['block'][t][i]['jPath'] + '"></img></button></td>';
						}
					}
					$('#map').append('<tr id="h' + t + '">' + inside + '</tr>');
				}

				drawMap();
			}


			function drawMap(){

				$("body").mousedown(function(){
					down = true;
				});

				$("body").mouseup(function(){
					down = false;
				});


				// Draw block here
				$(".block").click(function(){

					var x = parseInt($(this).attr('x'));
					var y = parseInt($(this).attr('y'));
					
					if(pen_tool['sprite_components'][0] == 'Eraser'){
						$(this).html('');
						$(this).removeAttr('none_border');
						mapJson['block'][x][y] = null;
					}else{
						$(this).html('');
						$(this).html('<img class="btn-block" src="' + ASSETS_DIRECTORY + pen_tool['jPath'] + '"></img>');
						$(this).attr('none_border', 'true');
						mapJson['block'][x][y] = JSON.parse(JSON.stringify(pen_tool));
					}

					//oalesceBlocks();

				});

				$(".block").hover(function(){
					if(down){
						$(this).click();
					}
				},function(){
					
				})

				$(".block").mousedown(function(){
					$(this).click();
				});

				$('.block').mouseup(function(){
					setTimeout(coalesceBlocks, 1);
				});

				

				$("#map-container").mouseenter(function(){
					down = false;
					coalesceBlocks();
				},function(){
					
				})



			}
			

			$('#map-setting').click(function(){
				var height = prompt('Height of the map (default 20): ');

				if(height == ''){
					height = 20;
				}

				var width = prompt('Width of the map (default 30): ');
				if(width == ''){
					width = 30;
				}

				if(confirm('This will clear and redraw the current map, are you sure?')){
					h = height;
					w = width;
					drawNewMap();
				}
			});


			// This function is for coalesce blocks to beautify map
			function coalesceBlocks(){

				for(var t = 0; t < h; t ++){
					for(var i = 0; i < w; i ++){
						var each = mapJson['block'][t][i];
						var next = mapJson['block'][t][i + 1];

						if(each == null || next == null || next == undefined || each['sprite_components'].length != next['sprite_components'].length){
							continue;
						}

						var componentDifferentDepth = 0;
						for(comp in each['sprite_components']){
							if(each['sprite_components'][comp] != next['sprite_components'][comp]){
								componentDifferentDepth ++;
							}
						}

						if(componentDifferentDepth > 1){
							continue;
						}


						var listArray = spriteDirectoryList;
						for(every of each['sprite_components']){
							if(listArray[every] == undefined || listArray instanceof Array){
								continue;
							}
							listArray = listArray[every];
						}

						var compsLength = listArray.length;
						var eachCompsLength = each['sprite_components'].length;
						var eachIndex = listArray.indexOf(1 * each['sprite_components'][eachCompsLength - 1]);
						var nextIndex = (eachIndex + 1) % compsLength;

						next['sprite_components'][eachCompsLength - 1] = "" + listArray[nextIndex];
						next['jPath'] = next['sprite_components'].join('_') + '.png';
						$('#h' + t + 'w' + (i + 1)).find('img').attr('src', ASSETS_DIRECTORY + next['jPath']);

					}
				}

			}







			function generateJava(){

				const import_lines = '\n\
package core.external.level;\n\
\n\
import core.ecs.components.*;\n\
import core.external.entity.*;\n\
import core.external.weapon.*;\n\
import core.map.*;\n\
import core.screens.ScreenBuilder;\n\
import core.sprite.*;\n\
\n\
import java.util.List;\n\
import java.util.ArrayList;\n\
\n\
\n\
				';

				const level_editor_json = JSON.stringify(mapJson);
				const level_editor_json_lines = '\n\
		/**\n\
		 ** !!! DO NOT DELETE THE FOLLOWING COMMENTS AS THEY ARE FOR RE-EDITING IN THE LEVEL EDITOR: \n\
		 	<!----level_editor----'+ level_editor_json + '---->\n\
		 **/\n\
 \n\
				';

				const constructor_head_lines = '\n\
public class LevelName extends GameMap {\n\
\n\
	private static double screenHeight = ScreenBuilder.getPrimaryScreenBounds().getHeight();\n\
	private static double screenWidth = ScreenBuilder.getPrimaryScreenBounds().getWidth();\n\
		\n\
	public LevelName() {\n\
		\n\
		List<Sprite> sprites = new ArrayList<Sprite>();\n\
		\n\
		\n\
				';	

				const constructor_tail_line = '\n\
		\n\
		for (Sprite sprite : sprites) {\n\
			super.addSprite(sprite);\n\
		}\n\
		\n\
	}\n\
	\n\
	\n\
}\n\
				';


				var tiles_lines = '';
				var varIncrement = 0;

				// Loop for all tiles
				for(var t = 0; t < h; t ++){
					for(var i = 0; i < w; i ++){
						varIncrement ++;

						var mapThis = mapJson['block'][t][i];
						console.log(mapThis);

						if(mapThis == undefined || mapThis == '' || mapThis == null){
							continue;
						}

						var block = mapThis['sprite_components'][0];
						var nameVar = mapThis['sprite_components'][1] + varIncrement;
						var imgPath = mapThis['jPath'];

						var newObject = 'TileObject';

						var spriteComponents = Array();

						if(block == 'Hero' || block == 'Enemy' || block == 'Block' || block == 'Treasure' || block == 'CheckPoint' || block == 'EndPoint'){
							spriteComponents.push('new CollidableComponent()');
						}
						if(block == 'Hero' || block == 'Enemy'){
							spriteComponents.push('new PhysicsComponent()');
							spriteComponents.push('new AttackComponent()');
							spriteComponents.push('new HealthComponent()');
							spriteComponents.push('new StateComponent()');
						}
						if(block == 'Hero'){
							spriteComponents.push('new WeaponComponent()');
							newObject = 'Hero';
						}
						if(block == 'Enemy'){
							spriteComponents.push('new AIComponent()');
							newObject = 'Enemy';
						}
						if(block == 'CheckPoint' || block == 'EndPoint'){
							spriteComponents.push('new EndPointComponent()');
						}

						var paramComponents = '';
						for(comp of spriteComponents){
							paramComponents += ', ' + comp;
						}

						// relative position and size

						var ratio = '(screenHeight * 0.063)';
						var width = ratio;
						var height = ratio;
						var left = i + ' * ' + ratio;
						var top = t + ' * ' + ratio;


						tiles_lines += '\n\
		TileObject ' + nameVar + ' = new ' + newObject + '(' + top + ', ' + left + ', ' + height + ' * 50, ' + width + ' * 50);\n\
		' + nameVar + '.addComponents(new RenderComponent(' + nameVar + ', "src/main/resources/assets/' + imgPath + '") ' + paramComponents + ');\n\
		sprites.add(' + nameVar + ');\n\
		\n\
						';
					}
				}

				const output = import_lines + constructor_head_lines + tiles_lines + level_editor_json_lines + constructor_tail_line;

				$('#java-code').val(output);

			}

		</script>

		<script>
			let substr = function(str, left, right){

				let leftIndex = str.indexOf(left) + left.length;
				let rightIndex = str.indexOf(right, leftIndex);
				let strLength = rightIndex - leftIndex;


				if(left < 0 || strLength < 0){
					return '';
				}
				return str.substr(leftIndex, strLength);

			}
		</script>

		<script>
	      feather.replace()
	    </script>

	</body>
</html>